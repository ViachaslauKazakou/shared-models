#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö AWS RDS
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–π –ë–î

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–¥–∞–ª–µ–Ω–Ω–æ–π –ë–î
REMOTE_DB_HOST="learn-service-test-postgres.cil0uc6gcdkj.us-east-1.rds.amazonaws.com"
REMOTE_DB_PORT="5432"
REMOTE_DB_USER="postgres"
REMOTE_DB_NAME="learnservice"

echo -e "${BLUE}üöÄ –°–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–π –ë–î${NC}"
echo -e "${BLUE}=================================================${NC}"
echo -e "${YELLOW}–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:${NC} ${REMOTE_DB_HOST}:${REMOTE_DB_PORT}/${REMOTE_DB_NAME}"
echo -e "${YELLOW}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:${NC} ${REMOTE_DB_USER}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Poetry
if ! command -v poetry &> /dev/null; then
    echo -e "${RED}‚ùå Poetry –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Poetry –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è psql
if ! command -v psql &> /dev/null; then
    echo -e "${RED}‚ùå psql –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PostgreSQL client –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.${NC}"
    exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
check_db_connection() {
    echo -e "${YELLOW}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–π –ë–î...${NC}"
    
    # –ó–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è, –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
    if [ -z "$PGPASSWORD" ]; then
        echo -e "${YELLOW}–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${REMOTE_DB_USER}:${NC}"
        read -s PGPASSWORD
        export PGPASSWORD
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    if psql -h "$REMOTE_DB_HOST" -p "$REMOTE_DB_PORT" -U "$REMOTE_DB_USER" -d "$REMOTE_DB_NAME" -c "\q" 2>/dev/null; then
        echo -e "${GREEN}‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–π –ë–î —É—Å–ø–µ—à–Ω–æ${NC}"
        return 0
    else
        echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–π –ë–î${NC}"
        echo -e "${RED}–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞${NC}"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
check_migration_status() {
    echo -e "${YELLOW}üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏
    echo -e "${BLUE}–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ —É–¥–∞–ª–µ–Ω–Ω–æ–π –ë–î:${NC}"
    poetry run alembic -c alembic.remote.ini current || echo -e "${YELLOW}–ú–∏–≥—Ä–∞—Ü–∏–∏ –µ—â–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã${NC}"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
    echo -e "${BLUE}–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏:${NC}"
    poetry run alembic -c alembic.remote.ini heads
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
apply_migrations() {
    echo -e "${YELLOW}üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–π –ë–î...${NC}"
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª
    if poetry run alembic -c alembic.remote.ini upgrade head; then
        echo -e "${GREEN}‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–π –ë–î${NC}"
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π${NC}"
        exit 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ç–∞–±–ª–∏—Ü –≤ –ë–î
show_tables() {
    echo -e "${YELLOW}üìä –¢–∞–±–ª–∏—Ü—ã –≤ —É–¥–∞–ª–µ–Ω–Ω–æ–π –ë–î:${NC}"
    psql -h "$REMOTE_DB_HOST" -p "$REMOTE_DB_PORT" -U "$REMOTE_DB_USER" -d "$REMOTE_DB_NAME" -c "\dt"
}

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    echo -e "${BLUE}–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:${NC}"
    echo "1) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"
    echo "2) –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π"
    echo "3) –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏"
    echo "4) –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã"
    echo "5) –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å—ë (–ø—Ä–æ–≤–µ—Ä–∫–∞ + –º–∏–≥—Ä–∞—Ü–∏–∏ + —Ç–∞–±–ª–∏—Ü—ã)"
    echo "6) –í—ã—Ö–æ–¥"
    echo ""
    echo -n "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (1-6): "
    read choice
    
    case $choice in
        1)
            check_db_connection
            ;;
        2)
            if check_db_connection; then
                check_migration_status
            fi
            ;;
        3)
            if check_db_connection; then
                echo -e "${YELLOW}‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ! –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ –£–î–ê–õ–ï–ù–ù–û–ô –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.${NC}"
                echo -e "${YELLOW}–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N):${NC}"
                read -r confirm
                if [[ $confirm =~ ^[Yy]$ ]]; then
                    apply_migrations
                    show_tables
                else
                    echo -e "${YELLOW}‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞${NC}"
                fi
            fi
            ;;
        4)
            if check_db_connection; then
                show_tables
            fi
            ;;
        5)
            if check_db_connection; then
                check_migration_status
                echo ""
                echo -e "${YELLOW}‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ! –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ –£–î–ê–õ–ï–ù–ù–û–ô –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.${NC}"
                echo -e "${YELLOW}–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N):${NC}"
                read -r confirm
                if [[ $confirm =~ ^[Yy]$ ]]; then
                    apply_migrations
                    echo ""
                    show_tables
                else
                    echo -e "${YELLOW}‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞${NC}"
                fi
            fi
            ;;
        6)
            echo -e "${GREEN}üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
            main
            ;;
    esac
}

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è Poetry –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –∑–∞–ø—É—Å–∫
echo -e "${YELLOW}üîß –ê–∫—Ç–∏–≤–∞—Ü–∏—è Poetry –æ–∫—Ä—É–∂–µ–Ω–∏—è...${NC}"
if poetry env info &>/dev/null; then
    echo -e "${GREEN}‚úÖ Poetry –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ${NC}"
    echo ""
    main
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ Poetry –æ–∫—Ä—É–∂–µ–Ω–∏—è${NC}"
    echo -e "${RED}–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å pyproject.toml${NC}"
    exit 1
fi
